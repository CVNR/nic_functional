#!/bin/bash -ef
#
# This doesn't work. I'ts just a log for turning into a script later
#

#PROJECT_DIR=/data/qb/Atlanta/projects/Rodriguez-Merit
#SUBJECT=sub-int99
#SESSION=ses-bl
# These change for each analysis
analysis=task-intdnwh
n_runs=4
# need to reduce the number of these.
task_name=task-cn

# minor section to dynamically select the analysis pipline used based on subject
# number

SUBNUM=`echo ${SUBJECT} | cut -c 8-`

if [ ${SUBNUM} -gt 90 ]
then
  anat_ana=anat-T1w_dev
else
  echo 'This command has not been prepared to deal with SUBJECT IDs < 90'
  exit 1
fi


func_dir=${PROJECT_DIR}/derivatives/${analysis}/${SUBJECT}/${SESSION}/func
anat_dir=${PROJECT_DIR}/derivatives/${anat_ana}/${SUBJECT}/${SESSION}/anat

t1=${anat_dir}/${SUBJECT}_${SESSION}_T1w_deoblq_axRPI_denoised.nii
t1_brain=${anat_dir}/${SUBJECT}_${SESSION}_T1w_deoblq_axRPI_denoised_brain_restore

#initialize all_dn
all_dn=

for run in `seq 1 1 ${n_runs}`; do
  echo run-${run}

  bold_name=${func_dir}/${SUBJECT}_${SESSION}_${task_name}_run-${run}
  denoised=${bold_name}_tshift_volreg_topapply_automask_denoised
  if [ `echo ${all_dn} | wc -c ` -gt 10 ]; then
    all_dn=${all_dn}+${denoised}.nii.gz
  else
    all_dn=${denoised}.nii.gz
  fi

done

3dTcat ${all_dn}

  toMPRAGE=${denoised}_toMPRAGE
  epi_mean=${func_dir}/rm.fMRI_${SUBJECT}_run-${run}_mean
  bb

  
  3dTcat 

  3dTstat -mean -prefix ${epi_mean}.nii ${denoised}.nii.gz

# Dan is trying this to save time
# https://ibic-uw.blogspot.com/2014/11/using-epireg-for-within-subject.html 
  ln -s ${t1_brain}-WM.nii.gz ${t1_brain}-wmseg.nii.gz

  epi_reg --epi=${epi_mean}.nii --t1=${t1}.nii --t1brain=${t1_brain}.nii.gz --out=${epi_mean}_toMPRAGE

  premat=${epi_mean}_toMPRAGE

  applywarp --interp=spline -i ${denoised}.nii.gz -r ${t1_brain}.nii.gz --premat=${premat}.mat -o ${toMPRAGE}

done
